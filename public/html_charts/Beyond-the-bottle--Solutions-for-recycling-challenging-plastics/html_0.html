<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Multilayer Plastics Flow and End-of-Life Fate</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            background-color: #ffffff;
        }
        
        .container {
            width: 950px;
            height: 650px;
            position: relative;
        }
        
        .title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            width: 100%;
        }
        
        .node rect {
            cursor: move;
            fill-opacity: 0.9;
            shape-rendering: crispEdges;
        }
        
        .node text {
            pointer-events: none;
            font-size: 12px;
            font-weight: bold;
        }
        
        .link {
            fill: none;
            stroke-opacity: 0.5;
        }
        
        .link:hover {
            stroke-opacity: 0.8;
        }
        
        .link-label {
            font-size: 11px;
            pointer-events: none;
            fill: #000;
            font-weight: bold;
        }
        
        .link-label-bg {
            fill: white;
            fill-opacity: 0.9;
            stroke: #ddd;
            stroke-width: 0.5;
        }
        
        .key-number {
            font-family: 'Georgia', serif;
            font-weight: bold;
            font-size: 13px;
        }
        
        .section-label {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
        
        .annotation {
            font-size: 11px;
            font-style: italic;
            fill: #555;
        }
        
        .annotation-bg {
            fill: white;
            fill-opacity: 0.9;
            stroke: #ddd;
            stroke-width: 0.5;
            rx: 3;
            ry: 3;
        }
        
        .source {
            position: absolute;
            bottom: 5px;
            left: 0;
            font-size: 10px;
            color: #666;
            width: 100%;
            text-align: center;
        }
        
        .legend {
            position: absolute;
            bottom: 25px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }

        .small-flow {
            stroke-width: 3px !important; /* Minimum width for small flows */
        }

        .icon {
            font-size: 14px;
            fill: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">Global Multilayer Plastics Flow and End-of-Life Fate</div>
        <div id="chart"></div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4DB6AC;"></div>
                <div>Production</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #42A5F5;"></div>
                <div>Recycling</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FF9800;"></div>
                <div>Incineration</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #9E9E9E;"></div>
                <div>Landfill</div>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #EF5350;"></div>
                <div>Environmental Leakage</div>
            </div>
        </div>
        
        <div class="source">Source: Data synthesized from Plastics Engineering (May 2024) and industry reports</div>
    </div>

    <script>
        // Define the dimensions and margins
        const margin = {top: 20, right: 50, bottom: 100, left: 50};
        const width = 850 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        // Create the SVG container
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Define the data for the Sankey diagram
        const data = {
            nodes: [
                // Production
                {name: "Total MLP Production\n15.3 Mt/year", group: "production"},
                
                // Waste Management
                {name: "Collection for Recycling", group: "recycling"},
                {name: "Incineration", group: "incineration"},
                {name: "Landfill", group: "landfill"},
                {name: "Leakage to Environment", group: "leakage"},
                
                // End Fate
                {name: "Mechanical Recycling", group: "recycling", icon: "recycle"},
                {name: "Chemical Recycling", group: "recycling", icon: "flask"},
                {name: "Energy Recovery", group: "incineration", icon: "fire"},
                {name: "Disposal", group: "landfill", icon: "trash"},
                {name: "Environmental Pollution", group: "leakage", icon: "water"}
            ],
            links: [
                // Production to Waste Management
                {source: 0, target: 1, value: 10, label: "10% (1.53 Mt)"},
                {source: 0, target: 2, value: 35, label: "35% (5.36 Mt)"},
                {source: 0, target: 3, value: 45, label: "45% (6.89 Mt)"},
                {source: 0, target: 4, value: 10, label: "10% (1.53 Mt)"},
                
                // Waste Management to End Fate
                {source: 1, target: 5, value: 1, label: "1% (0.15 Mt)"},
                {source: 1, target: 6, value: 0.5, label: "<1% (0.08 Mt)"},
                {source: 1, target: 7, value: 8.5, label: "8.5% (1.30 Mt)"},
                {source: 2, target: 7, value: 35, label: "35% (5.36 Mt)"},
                {source: 3, target: 8, value: 45, label: "45% (6.89 Mt)"},
                {source: 4, target: 9, value: 10, label: "10% (1.53 Mt)"}
            ]
        };

        // Set up the Sankey generator
        const sankey = d3.sankey()
            .nodeWidth(25)
            .nodePadding(15)
            .extent([[0, 0], [width, height]]);

        // Generate the Sankey data
        const sankeyData = sankey(data);

        // Define color scale based on groups
        const colorScale = d3.scaleOrdinal()
            .domain(["production", "recycling", "incineration", "landfill", "leakage"])
            .range(["#4DB6AC", "#42A5F5", "#FF9800", "#9E9E9E", "#EF5350"]);

        // Add the section labels
        const sections = [
            {name: "Production", x: width * 0.1, y: height + 30},
            {name: "Waste Management", x: width * 0.5, y: height + 30},
            {name: "End Fate", x: width * 0.85, y: height + 30}
        ];

        svg.selectAll(".section-label")
            .data(sections)
            .enter()
            .append("text")
            .attr("class", "section-label")
            .attr("x", d => d.x)
            .attr("y", d => d.y)
            .attr("text-anchor", "middle")
            .text(d => d.name);

        // Add the links (flows)
        const link = svg.append("g")
            .selectAll(".link")
            .data(sankeyData.links)
            .enter()
            .append("path")
            .attr("class", d => d.value < 5 ? "link small-flow" : "link")
            .attr("d", d3.sankeyLinkHorizontal())
            .attr("stroke", d => colorScale(data.nodes[d.source.index].group))
            .attr("stroke-width", d => Math.max(1, d.width))
            .style("stroke-opacity", 0.5);

        // Add the nodes
        const node = svg.append("g")
            .selectAll(".node")
            .data(sankeyData.nodes)
            .enter()
            .append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x0},${d.y0})`);

        // Add the rectangles for the nodes
        node.append("rect")
            .attr("height", d => d.y1 - d.y0)
            .attr("width", d => d.x1 - d.x0)
            .attr("fill", d => colorScale(d.group))
            .attr("stroke", "#000");

        // Add the titles for the nodes
        node.append("text")
            .attr("x", d => {
                if (d.x0 < width / 2) {
                    return d.x1 - d.x0 + 6;
                } else {
                    return -6;
                }
            })
            .attr("y", d => (d.y1 - d.y0) / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", d => (d.x0 < width / 2) ? "start" : "end")
            .text(d => d.name)
            .style("font-size", "12px");

        // Add icons to end fate nodes
        node.filter(d => d.icon)
            .append("foreignObject")
            .attr("width", 20)
            .attr("height", 20)
            .attr("x", d => d.x0 < width / 2 ? d.x1 - d.x0 + 10 : -30)
            .attr("y", d => (d.y1 - d.y0) / 2 - 10)
            .html(d => `<i class="fa fa-${d.icon}" style="font-size: 14px; color: #333;"></i>`);

        // Add background rectangles for flow labels to improve readability
        svg.append("g")
            .selectAll(".link-label-bg")
            .data(sankeyData.links)
            .enter()
            .append("rect")
            .attr("class", "link-label-bg")
            .attr("x", d => {
                const x = (d.source.x1 + d.target.x0) / 2;
                const width = d.label.length * 6; // Estimate text width
                return x - width / 2;
            })
            .attr("y", d => {
                // Position labels based on flow width
                if (d.width < 10) {
                    return d.y0 - 20; // Small flows get labels above
                } else {
                    return d.y0 + d.width / 2 - 10; // Larger flows get labels on them
                }
            })
            .attr("width", d => d.label.length * 6) // Estimate text width
            .attr("height", 18)
            .attr("rx", 3)
            .attr("ry", 3);

        // Add the flow labels
        svg.append("g")
            .selectAll(".link-label")
            .data(sankeyData.links)
            .enter()
            .append("text")
            .attr("class", "link-label")
            .attr("x", d => (d.source.x1 + d.target.x0) / 2)
            .attr("y", d => {
                // Position labels based on flow width
                if (d.width < 10) {
                    return d.y0 - 8; // Small flows get labels above
                } else {
                    return d.y0 + d.width / 2 + 4; // Larger flows get labels on them
                }
            })
            .attr("text-anchor", "middle")
            .each(function(d) {
                // Split the label into percentage and volume parts
                const parts = d.label.split(" ");
                const percentage = parts[0];
                const volume = parts.slice(1).join(" ");
                
                // Add the percentage with key-number class
                d3.select(this)
                    .append("tspan")
                    .attr("class", "key-number")
                    .text(percentage);
                
                // Add the volume
                d3.select(this)
                    .append("tspan")
                    .text(" " + volume);
            });

        // Add background for the main annotation
        svg.append("rect")
            .attr("class", "annotation-bg")
            .attr("x", width * 0.65 - 80)
            .attr("y", height * 0.15 - 20)
            .attr("width", 160)
            .attr("height", 40);

        // Add the main annotation about recycling
        svg.append("text")
            .attr("class", "annotation")
            .attr("x", width * 0.65)
            .attr("y", height * 0.15)
            .attr("text-anchor", "middle")
            .text("Only ~1% of MLPs actually recycled")
            .append("tspan")
            .attr("x", width * 0.65)
            .attr("dy", "1.2em")
            .text("despite 10% entering collection");

        // Add background for the MLP context annotation
        svg.append("rect")
            .attr("class", "annotation-bg")
            .attr("x", width * 0.15 - 80)
            .attr("y", height * 0.85 - 10)
            .attr("width", 160)
            .attr("height", 25);

        // Add a note about MLPs in context
        svg.append("text")
            .attr("class", "annotation")
            .attr("x", width * 0.15)
            .attr("y", height * 0.85)
            .attr("text-anchor", "middle")
            .text("MLPs represent ~17% of global flexible film output");

        // Add background for the incineration annotation
        svg.append("rect")
            .attr("class", "annotation-bg")
            .attr("x", width * 0.5 - 100)
            .attr("y", height * 0.7 - 10)
            .attr("width", 200)
            .attr("height", 25);

        // Add annotation about incineration/landfill
        svg.append("text")
            .attr("class", "annotation")
            .attr("x", width * 0.5)
            .attr("y", height * 0.7)
            .attr("text-anchor", "middle")
            .text("~2.6 Mt of MLPs are incinerated/landfilled annually");
    </script>
</body>
</html>