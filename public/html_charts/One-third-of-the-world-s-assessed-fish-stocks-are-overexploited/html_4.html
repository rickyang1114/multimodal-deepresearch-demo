<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact of Fisheries Subsidies on Global Fish Stocks</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f9f9f9;
        }
        
        .visualization-container {
            background-color: white;
            width: 1100px;
            padding: 30px;
            box-sizing: border-box;
        }
        
        .title {
            font-size: 18pt;
            font-weight: bold;
            color: #1A3A5C;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .panels-container {
            display: flex;
            justify-content: space-between;
        }
        
        .panel {
            width: 48%;
        }
        
        .subtitle {
            font-size: 14pt;
            font-weight: bold;
            color: #1A3A5C;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 10px;
            font-size: 10pt;
        }
        
        .legend-color {
            width: 14px;
            height: 14px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        .source {
            font-size: 8pt;
            color: #6c757d;
            text-align: center;
            margin-top: 30px;
        }
        
        .key-number {
            font-family: 'Georgia', serif;
            font-weight: bold;
        }
        
        .annotation-box {
            fill: rgba(108, 117, 125, 0.9);
            stroke: #1A3A5C;
            stroke-width: 1px;
            rx: 4;
            ry: 4;
        }
        
        .annotation-text {
            fill: white;
            font-size: 9pt;
        }
        
        #pie-legend {
            margin-top: 15px;
        }
        
        #line-legend {
            margin-top: 20px;
        }
        
        .legend-row {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="visualization-container">
        <div class="title">Impact of Fisheries Subsidies on Global Fish Stocks</div>
        
        <div class="panels-container">
            <div class="panel" id="pie-chart-panel">
                <div class="subtitle">Global Fisheries Subsidies (2018, USD billions)</div>
                <div id="pie-chart"></div>
                <div id="pie-legend"></div>
            </div>
            
            <div class="panel" id="line-chart-panel">
                <div class="subtitle">Projected Impact of Subsidy Removal on Global Fish Biomass</div>
                <div id="line-chart"></div>
                <div id="line-legend"></div>
            </div>
        </div>
        
        <div class="source">Source: Based on Sumaila et al. (2021) and WTO (2022)</div>
    </div>

    <script>
        // Data for the pie chart with more distinct colors
        const pieData = [
            { label: "Harmful fuel subsidies", value: 10.5, percentage: 30, color: "#E83A14" },
            { label: "Harmful vessel subsidies", value: 7.2, percentage: 20, color: "#F76E11" },
            { label: "Other harmful subsidies", value: 4.3, percentage: 12, color: "#FFAF5F" },
            { label: "Beneficial subsidies", value: 13.4, percentage: 38, color: "#4ABDAC" }
        ];

        // Data for the line chart
        const lineData = {
            years: [2020, 2025, 2030, 2035, 2040, 2045, 2050],
            businessAsUsual: [0, -1, -2, -3, -3.5, -4, -4.5],
            subsidyRemoval: [0, 2, 4.5, 7, 9, 11, 12.5]
        };

        // Create pie chart
        function createPieChart() {
            const width = 480;
            const height = 400;
            const radius = Math.min(width, height) / 2 - 70;

            const svg = d3.select("#pie-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2 - 20})`);

            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            const labelArc = d3.arc()
                .innerRadius(radius * 0.6)
                .outerRadius(radius * 0.6);

            const arcs = svg.selectAll(".arc")
                .data(pie(pieData))
                .enter()
                .append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => d.data.color);

            // Add percentage labels
            arcs.append("text")
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("dy", "-0.5em")
                .attr("text-anchor", "middle")
                .attr("fill", "white")
                .attr("font-size", "11pt")
                .attr("font-weight", "bold")
                .text(d => `${d.data.percentage}%`);

            // Add value labels
            arcs.append("text")
                .attr("transform", d => `translate(${labelArc.centroid(d)})`)
                .attr("dy", "1em")
                .attr("text-anchor", "middle")
                .attr("fill", "white")
                .attr("font-size", "10pt")
                .text(d => `$${d.data.value}B`);

            // Create legend with two rows
            const legend = d3.select("#pie-legend");
            
            // Clear any existing legend items
            legend.html("");
            
            // Create two rows for legend items (2 items per row)
            const row1 = legend.append("div").attr("class", "legend-row");
            const row2 = legend.append("div").attr("class", "legend-row");
            
            // Add first two items to row 1
            for (let i = 0; i < 2; i++) {
                const d = pieData[i];
                const legendItem = row1.append("div")
                    .attr("class", "legend-item");
                
                legendItem.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", d.color);
                
                legendItem.append("div")
                    .text(d.label);
            }
            
            // Add last two items to row 2
            for (let i = 2; i < 4; i++) {
                const d = pieData[i];
                const legendItem = row2.append("div")
                    .attr("class", "legend-item");
                
                legendItem.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", d.color);
                
                legendItem.append("div")
                    .text(d.label);
            }
        }

        // Create line chart
        function createLineChart() {
            const margin = { top: 40, right: 30, bottom: 70, left: 60 };
            const width = 480 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#line-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // Scales
            const x = d3.scaleLinear()
                .domain([2020, 2050])
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([-5, 15])
                .range([height, 0]);

            // X-axis
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x).tickFormat(d => d).ticks(7))
                .style("font-size", "10pt")
                .style("color", "#444");

            // Y-axis
            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => `${d}%`).ticks(5))
                .style("font-size", "10pt")
                .style("color", "#444");

            // Y-axis label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "10pt")
                .style("fill", "#444")
                .text("Change in global fish biomass (%)");

            // Gridlines
            svg.append("g")
                .attr("class", "grid")
                .selectAll("line")
                .data(y.ticks(5))
                .enter()
                .append("line")
                .attr("x1", 0)
                .attr("x2", width)
                .attr("y1", d => y(d))
                .attr("y2", d => y(d))
                .attr("stroke", "#EDEDED")
                .attr("stroke-width", 0.75);

            svg.append("g")
                .attr("class", "grid")
                .selectAll("line")
                .data(x.ticks(7))
                .enter()
                .append("line")
                .attr("x1", d => x(d))
                .attr("x2", d => x(d))
                .attr("y1", 0)
                .attr("y2", height)
                .attr("stroke", "#EDEDED")
                .attr("stroke-width", 0.75);

            // Reference line for WTO agreement
            svg.append("line")
                .attr("x1", x(2022))
                .attr("x2", x(2022))
                .attr("y1", 0)
                .attr("y2", height)
                .attr("stroke", "#6c757d")
                .attr("stroke-width", 1)
                .attr("stroke-dasharray", "3,3");

            svg.append("text")
                .attr("x", x(2022) + 5)
                .attr("y", 15)
                .attr("text-anchor", "start")
                .style("font-size", "8pt")
                .style("fill", "#6c757d")
                .text("WTO Agreement");

            // Area for subsidy removal line
            const area = d3.area()
                .x((d, i) => x(lineData.years[i]))
                .y0(height)
                .y1(d => y(d));

            svg.append("path")
                .datum(lineData.subsidyRemoval)
                .attr("fill", "#4ABDAC")
                .attr("fill-opacity", 0.3)
                .attr("d", area);

            // Business as usual line
            const line1 = d3.line()
                .x((d, i) => x(lineData.years[i]))
                .y(d => y(d));

            svg.append("path")
                .datum(lineData.businessAsUsual)
                .attr("fill", "none")
                .attr("stroke", "#E83A14")
                .attr("stroke-width", 2)
                .attr("d", line1);

            // Subsidy removal line
            const line2 = d3.line()
                .x((d, i) => x(lineData.years[i]))
                .y(d => y(d));

            svg.append("path")
                .datum(lineData.subsidyRemoval)
                .attr("fill", "none")
                .attr("stroke", "#4ABDAC")
                .attr("stroke-width", 2)
                .attr("d", line2);

            // Add circles for data points - Business as usual
            svg.selectAll(".dot-bau")
                .data(lineData.businessAsUsual)
                .enter()
                .append("circle")
                .attr("class", "dot-bau")
                .attr("cx", (d, i) => x(lineData.years[i]))
                .attr("cy", d => y(d))
                .attr("r", 4)
                .attr("fill", "#E83A14");

            // Add circles for data points - Subsidy removal
            svg.selectAll(".dot-sr")
                .data(lineData.subsidyRemoval)
                .enter()
                .append("circle")
                .attr("class", "dot-sr")
                .attr("cx", (d, i) => x(lineData.years[i]))
                .attr("cy", d => y(d))
                .attr("r", 4)
                .attr("fill", "#4ABDAC");

            // Improved annotation box
            svg.append("rect")
                .attr("class", "annotation-box")
                .attr("x", width - 220)
                .attr("y", 5)
                .attr("width", 210)
                .attr("height", 60);

            svg.append("text")
                .attr("class", "annotation-text")
                .attr("x", width - 210)
                .attr("y", 22)
                .text("Eliminating harmful subsidies would")
                .attr("dominant-baseline", "middle");

            svg.append("text")
                .attr("class", "annotation-text")
                .attr("x", width - 210)
                .attr("y", 40)
                .html("boost global fish biomass by <tspan class='key-number' style='font-size: 10pt;'>12.5%</tspan>")
                .attr("dominant-baseline", "middle");

            svg.append("text")
                .attr("class", "annotation-text")
                .attr("x", width - 210)
                .attr("y", 55)
                .text("(≈35 million MT) by 2050")
                .attr("dominant-baseline", "hanging");

            // Create legend with better positioning - two items in a row
            const legend = d3.select("#line-legend");
            
            // Clear any existing legend items
            legend.html("");
            
            // Create a single row for the line chart legend
            const legendRow = legend.append("div").attr("class", "legend-row");
            
            const lineDataLegend = [
                { label: "Business as usual", color: "#E83A14" },
                { label: "Removal of harmful subsidies", color: "#4ABDAC" }
            ];
            
            lineDataLegend.forEach(d => {
                const legendItem = legendRow.append("div")
                    .attr("class", "legend-item");
                
                legendItem.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", d.color);
                
                legendItem.append("div")
                    .text(d.label);
            });
        }

        // Initialize charts
        createPieChart();
        createLineChart();
    </script>
</body>
</html>