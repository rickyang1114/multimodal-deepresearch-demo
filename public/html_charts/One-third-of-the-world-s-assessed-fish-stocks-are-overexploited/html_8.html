<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuna Fisheries Management Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        
        .visualization-container {
            width: 950px;
            height: 650px;
            background-color: white;
            position: relative;
        }
        
        .title {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            color: #1A3A5C; /* midnight navy */
            margin-top: 15px;
            margin-bottom: 25px;
        }
        
        .subtitle {
            font-size: 15px;
            font-weight: 500;
            text-align: center;
            color: #1A3A5C; /* midnight navy */
            margin-bottom: 15px;
        }
        
        .panel {
            position: absolute;
            width: 50%;
            height: 450px;
        }
        
        .left-panel {
            left: 0;
            top: 70px;
        }
        
        .right-panel {
            right: 0;
            top: 70px;
        }
        
        .legend {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: row;
            gap: 40px;
            justify-content: center;
            width: 100%;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 11px;
            color: #333;
        }
        
        .legend-color {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            display: inline-block;
        }
        
        .source {
            position: absolute;
            bottom: 15px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 9px;
            color: #7D8CA3; /* slate gray */
        }
        
        .key-number {
            font-family: 'Georgia', serif;
            font-weight: bold;
        }
        
        .annotation-box {
            position: absolute;
            background-color: #1A3A5C; /* darker background for better contrast */
            border: 1px solid #1A3A5C; /* midnight navy */
            padding: 8px 12px;
            border-radius: 4px;
            color: white;
            font-size: 11px;
            text-align: center;
            transform: translate(-50%, -50%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="visualization-container">
        <div class="title">Success in Tuna Fisheries Management Through Science-Based Approaches</div>
        
        <div class="panel left-panel">
            <div class="subtitle">Sustainability Status of Tuna Stocks by RFMO</div>
            <svg id="radar-chart" width="470" height="430"></svg>
        </div>
        
        <div class="panel right-panel">
            <div class="subtitle">Adoption of Management Strategy Evaluation (MSE) Practices</div>
            <svg id="bar-chart" width="470" height="430"></svg>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4ABDAC;"></div>
                <span>Sustainable stocks (B>BMSY)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #7D8CA3;"></div>
                <span>Fully exploited stocks (Bâ‰ˆBMSY)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FC4A1A;"></div>
                <span>Overexploited stocks (B&lt;BMSY)</span>
            </div>
        </div>
        
        <div class="source">Source: Based on ISSF Status of the Stocks Report 2023</div>
    </div>

    <script>
        // Data for the radar chart
        const radarData = {
            axes: [
                'ICCAT (Atlantic)', 
                'IOTC (Indian Ocean)', 
                'WCPFC (Western Pacific)', 
                'IATTC (Eastern Pacific)', 
                'CCSBT (Southern Bluefin)', 
                'Multi-RFMO Stocks'
            ],
            values: [85, 78, 95, 87, 100, 80]
        };

        // Data for the bar chart
        const barData = [
            { practice: 'Science-based harvest control rules', adoption: 82 },
            { practice: 'Robust stock assessment models', adoption: 96 },
            { practice: 'Pre-agreed management actions', adoption: 73 },
            { practice: 'Target and limit reference points', adoption: 88 },
            { practice: 'Multilateral recovery plans', adoption: 65 },
            { practice: 'Real-time monitoring systems', adoption: 54 }
        ];

        // Sort bar data by adoption rate (descending)
        barData.sort((a, b) => b.adoption - a.adoption);

        // Create radar chart
        function createRadarChart() {
            const svg = d3.select('#radar-chart');
            const width = +svg.attr('width');
            const height = +svg.attr('height');
            const radius = Math.min(width, height) / 2 - 80;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Create scales
            const angleScale = d3.scaleLinear()
                .domain([0, radarData.axes.length])
                .range([0, 2 * Math.PI]);
            
            const radiusScale = d3.scaleLinear()
                .domain([0, 100])
                .range([0, radius]);
            
            // Draw concentric circles with percentage labels
            const circles = [20, 40, 60, 80, 100];
            circles.forEach(value => {
                svg.append('circle')
                    .attr('cx', centerX)
                    .attr('cy', centerY)
                    .attr('r', radiusScale(value))
                    .attr('fill', 'none')
                    .attr('stroke', '#EDEDED')
                    .attr('stroke-width', 0.5)
                    .attr('stroke-dasharray', '3,3');
                
                // Add percentage labels for reference circles (except 100% to avoid clutter)
                if (value < 100) {
                    svg.append('text')
                        .attr('x', centerX + 5)
                        .attr('y', centerY - radiusScale(value) + 3)
                        .attr('font-size', '9px')
                        .attr('fill', '#999')
                        .text(`${value}%`);
                }
            });
            
            // Draw axes
            radarData.axes.forEach((axis, i) => {
                const angle = angleScale(i);
                const lineX = centerX + radius * Math.sin(angle);
                const lineY = centerY - radius * Math.cos(angle);
                
                svg.append('line')
                    .attr('x1', centerX)
                    .attr('y1', centerY)
                    .attr('x2', lineX)
                    .attr('y2', lineY)
                    .attr('stroke', 'black')
                    .attr('stroke-width', 0.75);
                
                // Position axis labels with improved positioning logic
                const labelRadius = radius + 35; // Increased for better spacing
                let labelX = centerX + labelRadius * Math.sin(angle);
                let labelY = centerY - labelRadius * Math.cos(angle);
                
                // Adjust text anchor based on position
                const textAnchor = () => {
                    if (Math.abs(angle - Math.PI/2) < 0.3) return 'start';
                    if (Math.abs(angle - 3*Math.PI/2) < 0.3) return 'end';
                    return angle > Math.PI - 0.3 && angle < Math.PI + 0.3 ? 'middle' : (angle > Math.PI ? 'end' : 'start');
                };
                
                const dominantBaseline = () => {
                    if (Math.abs(angle) < 0.3 || Math.abs(angle - 2*Math.PI) < 0.3) return 'auto';
                    if (Math.abs(angle - Math.PI) < 0.3) return 'hanging';
                    return angle > Math.PI/2 && angle < 3*Math.PI/2 ? 'hanging' : 'auto';
                };
                
                // Create a text element for each axis label
                const text = svg.append('text')
                    .attr('x', labelX)
                    .attr('y', labelY)
                    .attr('text-anchor', textAnchor())
                    .attr('dominant-baseline', dominantBaseline())
                    .attr('font-size', '11px')
                    .attr('fill', '#333');
                
                // Split the label into multiple lines if needed
                const words = axis.split(' ');
                if (words.length > 2) {
                    // For Multi-RFMO Stocks, special handling
                    if (axis === 'Multi-RFMO Stocks') {
                        text.append('tspan')
                            .attr('x', labelX)
                            .attr('dy', '-0.6em')
                            .text('Multi-RFMO');
                        
                        text.append('tspan')
                            .attr('x', labelX)
                            .attr('dy', '1.2em')
                            .text('Stocks');
                    } else {
                        const firstLine = words.slice(0, 2).join(' ');
                        const secondLine = words.slice(2).join(' ');
                        
                        text.append('tspan')
                            .attr('x', labelX)
                            .attr('dy', '-0.6em')
                            .text(firstLine);
                        
                        text.append('tspan')
                            .attr('x', labelX)
                            .attr('dy', '1.2em')
                            .text(secondLine);
                    }
                } else {
                    text.text(axis);
                }
            });
            
            // Create radar polygon
            const radarLine = d3.lineRadial()
                .angle((d, i) => angleScale(i))
                .radius(d => radiusScale(d))
                .curve(d3.curveLinearClosed);
            
            svg.append('path')
                .datum(radarData.values)
                .attr('d', radarLine)
                .attr('transform', `translate(${centerX}, ${centerY})`)
                .attr('fill', '#4ABDAC')
                .attr('fill-opacity', 0.6) // Reduced opacity for better contrast with labels
                .attr('stroke', '#4ABDAC')
                .attr('stroke-width', 2);
            
            // Add percentage values at vertices with improved positioning
            radarData.values.forEach((value, i) => {
                const angle = angleScale(i);
                const pointRadius = radiusScale(value);
                
                // Calculate position for percentage labels with offset from vertices
                // Move labels outside the polygon for better visibility
                const labelOffsetFactor = 1.12; // Move labels 12% outside the polygon
                const pointX = centerX + pointRadius * Math.sin(angle);
                const pointY = centerY - pointRadius * Math.cos(angle);
                const labelX = centerX + (pointRadius * labelOffsetFactor) * Math.sin(angle);
                const labelY = centerY - (pointRadius * labelOffsetFactor) * Math.cos(angle);
                
                // Add data point
                svg.append('circle')
                    .attr('cx', pointX)
                    .attr('cy', pointY)
                    .attr('r', 3.5)
                    .attr('fill', '#4ABDAC')
                    .attr('stroke', 'white')
                    .attr('stroke-width', 1);
                
                // Add percentage label with background for better visibility
                const labelBg = svg.append('rect')
                    .attr('x', labelX - 15)
                    .attr('y', labelY - 10)
                    .attr('width', 30)
                    .attr('height', 20)
                    .attr('rx', 4)
                    .attr('fill', 'white')
                    .attr('fill-opacity', 0.8);
                
                svg.append('text')
                    .attr('x', labelX)
                    .attr('y', labelY + 5)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '12px')
                    .attr('font-weight', 'bold')
                    .attr('class', 'key-number')
                    .attr('fill', '#4ABDAC')
                    .text(`${value}%`);
            });
            
            // Add annotation box with improved sizing and contrast
            svg.append('rect')
                .attr('x', centerX - 110)
                .attr('y', centerY - 18)
                .attr('width', 220)
                .attr('height', 36)
                .attr('fill', '#1A3A5C') // Darker background for better contrast
                .attr('stroke', '#1A3A5C')
                .attr('stroke-width', 1)
                .attr('rx', 4)
                .attr('opacity', 0.9);
            
            // Add annotation text with better formatting
            const annotationText = svg.append('text')
                .attr('x', centerX)
                .attr('y', centerY)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .attr('font-size', '12px')
                .attr('fill', 'white');
                
            annotationText.append('tspan')
                .text('Global average: ');
                
            annotationText.append('tspan')
                .attr('font-weight', 'bold')
                .attr('class', 'key-number')
                .attr('font-size', '14px')
                .text('87%');
                
            annotationText.append('tspan')
                .text(' of tuna stocks sustainably fished');
        }
        
        // Create bar chart
        function createBarChart() {
            const svg = d3.select('#bar-chart');
            const width = +svg.attr('width');
            const height = +svg.attr('height');
            const margin = { top: 20, right: 70, bottom: 30, left: 210 }; // Increased left margin
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Create scales
            const xScale = d3.scaleLinear()
                .domain([0, 100])
                .range([0, chartWidth]);
            
            const yScale = d3.scaleBand()
                .domain(barData.map(d => d.practice))
                .range([0, chartHeight])
                .padding(0.35); // Increased padding for better spacing
            
            // Create color scale based on adoption rate
            const colorScale = d3.scaleLinear()
                .domain([d3.min(barData, d => d.adoption), d3.max(barData, d => d.adoption)])
                .range(['#7D8CA3', '#4ABDAC']);
            
            // Create chart group
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            // Add x-axis with improved styling
            g.append('g')
                .attr('transform', `translate(0, ${chartHeight})`)
                .call(d3.axisBottom(xScale)
                    .ticks(5)
                    .tickFormat(d => `${d}%`))
                .call(g => g.select('.domain').remove())
                .call(g => g.selectAll('.tick line')
                    .attr('stroke', '#EDEDED')
                    .attr('stroke-width', 0.75))
                .call(g => g.selectAll('.tick text')
                    .attr('font-size', '10px')
                    .attr('fill', '#555'));
            
            // Add x-axis label
            g.append('text')
                .attr('x', chartWidth / 2)
                .attr('y', chartHeight + 25)
                .attr('text-anchor', 'middle')
                .attr('font-size', '10px')
                .attr('fill', '#555')
                .text('Adoption rate (%)');
            
            // Add y-axis with improved text wrapping
            g.append('g')
                .call(d3.axisLeft(yScale))
                .call(g => g.select('.domain').remove())
                .call(g => g.selectAll('.tick line').remove())
                .call(g => g.selectAll('.tick text')
                    .attr('font-size', '11px')
                    .attr('fill', '#333')
                    .call(wrap, margin.left - 15));
            
            // Add horizontal gridlines
            g.selectAll('.gridline')
                .data(barData)
                .enter()
                .append('line')
                .attr('class', 'gridline')
                .attr('x1', 0)
                .attr('x2', chartWidth)
                .attr('y1', d => yScale(d.practice) + yScale.bandwidth())
                .attr('y2', d => yScale(d.practice) + yScale.bandwidth())
                .attr('stroke', '#EDEDED')
                .attr('stroke-width', 0.75);
            
            // Add bars with improved styling
            g.selectAll('.bar')
                .data(barData)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', 0)
                .attr('y', d => yScale(d.practice))
                .attr('width', d => xScale(d.adoption))
                .attr('height', yScale.bandwidth())
                .attr('fill', d => colorScale(d.adoption))
                .attr('rx', 3)
                .attr('ry', 3);
            
            // Add percentage labels with improved styling
            g.selectAll('.label')
                .data(barData)
                .enter()
                .append('text')
                .attr('class', 'label key-number')
                .attr('x', d => xScale(d.adoption) + 8)
                .attr('y', d => yScale(d.practice) + yScale.bandwidth() / 2 + 4)
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .attr('fill', d => {
                    // Darker text color for better readability
                    const color = d3.color(colorScale(d.adoption));
                    color.opacity = 1;
                    return color.darker(0.5);
                })
                .text(d => `${d.adoption}%`);
            
            // Improved function to wrap text
            function wrap(text, width) {
                text.each(function() {
                    const text = d3.select(this);
                    const words = text.text().split(/\s+/);
                    let line = [];
                    let lineNumber = 0;
                    const lineHeight = 1.1;
                    const y = text.attr("y");
                    const dy = parseFloat(text.attr("dy") || 0);
                    let tspan = text.text(null).append("tspan").attr("x", -10).attr("y", y).attr("dy", dy + "em");
                    
                    let currentLine = "";
                    words.forEach((word, i) => {
                        const testLine = currentLine + (currentLine ? " " : "") + word;
                        // Check if adding this word would make the line too long
                        if (testLine.length * 5.8 > width && i > 0) { // Adjusted approximation for text width
                            tspan.text(currentLine);
                            tspan = text.append("tspan").attr("x", -10).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                            currentLine = word;
                        } else {
                            currentLine = testLine;
                        }
                    });
                    
                    if (currentLine) {
                        tspan.text(currentLine);
                    }
                });
            }
        }
        
        // Initialize charts
        createRadarChart();
        createBarChart();
    </script>
</body>
</html>