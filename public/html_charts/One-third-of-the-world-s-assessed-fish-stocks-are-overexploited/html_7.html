<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Rebuilding Success Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: 'Arial', sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        padding: 20px;
      }

      .visualization-container {
        width: 850px;
        height: 620px;
        background-color: white;
        position: relative;
      }

      .title {
        font-size: 18pt;
        font-weight: bold;
        text-align: center;
        color: #1a2b4a; /* midnight navy */
        margin-top: 10px;
        margin-bottom: 20px;
      }

      .subtitle {
        font-size: 14pt;
        font-weight: 500;
        text-align: center;
        color: #1a2b4a;
        margin-bottom: 10px;
      }

      .left-panel {
        position: absolute;
        left: 0;
        top: 60px;
        width: 60%;
        height: 350px;
      }

      .right-panel {
        position: absolute;
        right: 0;
        top: 60px;
        width: 40%;
        height: 350px;
      }

      .mini-chart {
        background-color: #f5f5f5;
        margin-bottom: 20px;
        padding: 10px;
        border-radius: 4px;
      }

      .stock-name {
        font-size: 12pt;
        font-weight: bold;
        color: #1a2b4a;
        margin-bottom: 5px;
        text-align: center;
      }

      .rebuilding-note {
        font-size: 9pt;
        font-style: italic;
        color: #708090; /* slate gray */
        text-align: center;
        margin-top: 5px;
      }

      .annotation-box {
        position: absolute;
        background-color: rgba(65, 85, 110, 0.9); /* Darker, more opaque background */
        color: white;
        padding: 8px;
        border: 1px solid #1a2b4a;
        border-radius: 4px;
        font-size: 10pt;
        max-width: 200px;
        left: 25%;
        top: 80px;
        transform: translateX(-50%);
        z-index: 10;
      }

      .explanation-box {
        position: absolute;
        top: 430px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        background-color: #f5f5f5;
        border: 1px solid #708090;
        padding: 10px;
        font-size: 10pt;
        color: #333;
        border-radius: 4px;
      }

      .explanation-box .highlight {
        font-family: 'Georgia', serif;
        font-weight: bold;
        font-size: 11pt;
        color: #1a2b4a;
      }

      .source {
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 8pt;
        color: #708090;
      }

      .axis-label {
        font-size: 10pt;
        fill: #444;
      }

      .grid line {
        stroke: #ededed;
        stroke-width: 0.75px;
      }

      .y-axis-label {
        font-size: 10pt;
        fill: #444;
      }
    </style>
  </head>
  <body>
    <div class="visualization-container">
      <div class="title">
        Stock Rebuilding Success Under MSY-Based Annual Catch Limits in the United States
      </div>

      <div class="left-panel">
        <div class="subtitle">Cumulative number of rebuilt stocks, 2000-2019</div>
        <svg id="main-chart" width="100%" height="100%"></svg>
        <div class="annotation-box">
          By end of 2019: <span class="highlight">47</span> stocks rebuilt, only
          <span class="highlight">22</span> of 321 assessed stocks still overfishing, and
          <span class="highlight">46</span> of 244 still overfished
        </div>
      </div>

      <div class="right-panel">
        <div class="subtitle">Case Studies: 2019 Rebuilt Stocks</div>
        <div class="mini-chart">
          <div class="stock-name">Southern California Cowcod</div>
          <svg id="case-study-1" width="100%" height="120px"></svg>
          <div class="rebuilding-note">Rebuilding period: 19 years, B/BMSY now â‰¥ target</div>
        </div>
        <div class="mini-chart">
          <div class="stock-name">American Plaice</div>
          <svg id="case-study-2" width="100%" height="120px"></svg>
          <div class="rebuilding-note">Rebuilding period: 15 years, biomass tripled</div>
        </div>
      </div>

      <div class="explanation-box">
        The implementation of strict legally-mandated rebuilding plans has driven
        <span class="highlight">significant recovery</span> of U.S. fish stocks. These successes
        demonstrate that even severely depleted stocks can recover with sustained commitment to
        science-based catch limits, though rebuilding timeframes often extend to
        <span class="highlight">15-20 years</span>.
      </div>

      <div class="source">Source: NOAA Status of Stocks 2019</div>
    </div>

    <script>
      // Main chart data
      const mainChartData = [
        { year: 2000, count: 0 },
        { year: 2001, count: 2 },
        { year: 2002, count: 4 },
        { year: 2003, count: 7 },
        { year: 2004, count: 10 },
        { year: 2005, count: 13 },
        { year: 2006, count: 16 },
        { year: 2007, count: 20 },
        { year: 2008, count: 23 },
        { year: 2009, count: 27 },
        { year: 2010, count: 31 },
        { year: 2011, count: 34 },
        { year: 2012, count: 37 },
        { year: 2013, count: 40 },
        { year: 2014, count: 41 },
        { year: 2015, count: 42 },
        { year: 2016, count: 44 },
        { year: 2017, count: 45 },
        { year: 2018, count: 45 },
        { year: 2019, count: 47 },
      ]

      // Case study 1 data - Southern California Cowcod
      const caseStudy1Data = [
        { year: 2000, biomass: 5 },
        { year: 2003, biomass: 8 },
        { year: 2006, biomass: 15 },
        { year: 2009, biomass: 30 },
        { year: 2012, biomass: 50 },
        { year: 2015, biomass: 75 },
        { year: 2017, biomass: 90 },
        { year: 2019, biomass: 105 },
      ]

      // Case study 2 data - American Plaice
      const caseStudy2Data = [
        { year: 2004, biomass: 30 },
        { year: 2007, biomass: 40 },
        { year: 2010, biomass: 55 },
        { year: 2013, biomass: 70 },
        { year: 2016, biomass: 85 },
        { year: 2019, biomass: 110 },
      ]

      // Create main chart
      function createMainChart() {
        const svg = d3.select('#main-chart')
        const width = svg.node().getBoundingClientRect().width
        const height = svg.node().getBoundingClientRect().height
        const margin = { top: 20, right: 30, bottom: 40, left: 60 }
        const chartWidth = width - margin.left - margin.right
        const chartHeight = height - margin.top - margin.bottom

        const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`)

        // Scales
        const x = d3.scaleLinear().domain([2000, 2019]).range([0, chartWidth])

        const y = d3.scaleLinear().domain([0, 50]).range([chartHeight, 0])

        // Line generator
        const line = d3
          .line()
          .x((d) => x(d.year))
          .y((d) => y(d.count))
          .curve(d3.curveMonotoneX)

        // Area generator
        const area = d3
          .area()
          .x((d) => x(d.year))
          .y0(chartHeight)
          .y1((d) => y(d.count))
          .curve(d3.curveMonotoneX)

        // Add gridlines
        g.append('g')
          .attr('class', 'grid')
          .call(d3.axisLeft(y).tickSize(-chartWidth).tickFormat('').ticks(5))

        // Add area
        g.append('path')
          .datum(mainChartData)
          .attr('fill', '#4ABDAC')
          .attr('fill-opacity', 0.3)
          .attr('d', area)

        // Add line
        g.append('path')
          .datum(mainChartData)
          .attr('fill', 'none')
          .attr('stroke', '#4ABDAC')
          .attr('stroke-width', 1.5)
          .attr('d', line)

        // Add points
        g.selectAll('.point')
          .data(mainChartData)
          .enter()
          .append('circle')
          .attr('class', 'point')
          .attr('cx', (d) => x(d.year))
          .attr('cy', (d) => y(d.count))
          .attr('r', 4)
          .attr('fill', '#4ABDAC')

        // Add x-axis
        g.append('g')
          .attr('transform', `translate(0,${chartHeight})`)
          .call(d3.axisBottom(x).tickFormat(d3.format('d')).ticks(10))

        // Add y-axis
        g.append('g').call(d3.axisLeft(y).ticks(5))

        // Add x-axis label
        g.append('text')
          .attr('class', 'axis-label')
          .attr('text-anchor', 'middle')
          .attr('x', chartWidth / 2)
          .attr('y', chartHeight + margin.bottom - 5)
          .text('Year')

        // Add y-axis label - properly positioned
        g.append('text')
          .attr('class', 'y-axis-label')
          .attr('text-anchor', 'middle')
          .attr('transform', 'rotate(-90)')
          .attr('x', -chartHeight / 2)
          .attr('y', -margin.left + 20)
          .text('Cumulative number of rebuilt stocks')
      }

      // Create case study charts
      function createCaseStudyChart(selector, data, startYear) {
        const svg = d3.select(selector)
        const width = svg.node().getBoundingClientRect().width
        const height = svg.node().getBoundingClientRect().height
        const margin = { top: 10, right: 20, bottom: 30, left: 60 } // Increased left margin for y-axis labels
        const chartWidth = width - margin.left - margin.right
        const chartHeight = height - margin.top - margin.bottom

        const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`)

        // Determine appropriate y-domain based on data
        const minBiomass = d3.min(data, (d) => d.biomass)
        const yMin = 0 // Always start at 0 for biomass percentage

        // Scales
        const x = d3
          .scaleLinear()
          .domain([startYear || 2000, 2019])
          .range([0, chartWidth])

        const y = d3.scaleLinear().domain([yMin, 120]).range([chartHeight, 0])

        // Line generator
        const line = d3
          .line()
          .x((d) => x(d.year))
          .y((d) => y(d.biomass))
          .curve(d3.curveMonotoneX)

        // Add target line
        g.append('line')
          .attr('x1', 0)
          .attr('y1', y(100))
          .attr('x2', chartWidth)
          .attr('y2', y(100))
          .attr('stroke', '#888')
          .attr('stroke-width', 1)
          .attr('stroke-dasharray', '3,3')

        // Add target text
        g.append('text')
          .attr('x', chartWidth - 5)
          .attr('y', y(100) - 5)
          .attr('text-anchor', 'end')
          .attr('font-size', '8pt')
          .attr('fill', '#888')
          .text('Target')

        // Add line
        g.append('path')
          .datum(data)
          .attr('fill', 'none')
          .attr('stroke', '#4ABDAC')
          .attr('stroke-width', 1.25)
          .attr('d', line)

        // Add x-axis
        g.append('g')
          .attr('transform', `translate(0,${chartHeight})`)
          .call(d3.axisBottom(x).tickFormat(d3.format('d')).ticks(5))

        // Add y-axis with proper spacing and explicit 0% tick
        g.append('g').call(
          d3
            .axisLeft(y)
            .ticks(6) // Increased to include 0%
            .tickFormat((d) => d + '%')
            .tickPadding(8) // Increased padding between tick labels and axis
        )

        // Add y-axis label with better positioning
        g.append('text')
          .attr('class', 'axis-label')
          .attr('text-anchor', 'middle')
          .attr('transform', 'rotate(-90)')
          .attr('x', -chartHeight / 2)
          .attr('y', -margin.left + 15)
          .attr('font-size', '9pt')
          .text('Biomass (% of target)')
      }

      // Initialize charts
      document.addEventListener('DOMContentLoaded', function () {
        createMainChart()
        createCaseStudyChart('#case-study-1', caseStudy1Data, 2000)
        createCaseStudyChart('#case-study-2', caseStudy2Data, 2004)
      })
    </script>
  </body>
</html>
