<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regional Disparities in Fish Stock Sustainability, 2021</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        
        .container {
            width: 1000px;
            background-color: white;
        }
        
        .title {
            font-size: 18pt;
            font-weight: bold;
            color: #191970; /* midnight navy */
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 12pt;
            color: #7D8CA3; /* slate gray */
            margin-bottom: 20px;
        }
        
        .source {
            font-size: 8pt;
            color: #A9B4C6; /* light slate gray */
            margin-top: 15px;
        }
        
        .annotation {
            background-color: rgba(125, 140, 163, 0.8); /* slate gray with 80% opacity */
            border: 1px solid #191970; /* midnight navy */
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 9pt;
            color: white;
            max-width: 200px;
            pointer-events: none;
        }
        
        .percentage {
            font-family: 'Georgia', serif;
            font-weight: bold;
            font-size: 12pt;
        }
        
        .threshold-label {
            font-size: 10pt;
            font-weight: bold;
            fill: #7D8CA3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">Regional Disparities in Fish Stock Sustainability, 2021</div>
        <div class="subtitle">Percentage of stocks within biologically sustainable levels by FAO Major Fishing Area</div>
        <div id="chart"></div>
        <div class="source">Source: FAO State of World Fisheries and Aquaculture (SOFIA) 2024</div>
    </div>

    <script>
        // Data preparation
        const data = [
            { region: "Eastern Central Pacific (77)", value: 84.2, tier: "high", annotation: "Strong regional frameworks via Inter-American Tropical Tuna Commission" },
            { region: "Western Central Pacific (71)", value: 83.3, tier: "high" },
            { region: "Northeast Pacific (67)", value: 76.5, tier: "high", annotation: "MSY-aligned TACs set by North Pacific Fishery Management Council" },
            { region: "Southwest Pacific (81)", value: 75.0, tier: "high" },
            { region: "Eastern Central Atlantic (34)", value: 66.7, tier: "moderate" },
            { region: "Northwest Pacific (61)", value: 62.5, tier: "moderate" },
            { region: "Western Indian Ocean (51)", value: 62.5, tier: "moderate" },
            { region: "Western Central Atlantic (31)", value: 57.1, tier: "moderate" },
            { region: "Northeast Atlantic (27)", value: 56.3, tier: "moderate" },
            { region: "Southwest Atlantic (41)", value: 46.2, tier: "poor" },
            { region: "Mediterranean & Black Sea (37)", value: 37.5, tier: "poor", annotation: "0.8% improvement since 2019, still highly overexploited" },
            { region: "Southeast Pacific (87)", value: 33.3, tier: "poor", annotation: "Severe overexploitation of jumbo flying squid, South American pilchard, and hake stocks" }
        ];

        // Color mapping based on sustainability tier
        const colorScale = d => {
            if (d.tier === "high") return "#4ABDAC"; // Teal
            if (d.tier === "moderate") return "#7D8CA3"; // Slate gray
            return "#FC4A1A"; // Coral for poor
        };

        // Set up dimensions - increased height to accommodate annotations better
        const margin = { top: 40, right: 250, bottom: 50, left: 250 };
        const width = 1000 - margin.left - margin.right;
        const height = 600 - margin.top - margin.bottom;
        const barHeight = 28;

        // Create SVG
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        // Create scales
        const x = d3.scaleLinear()
            .domain([0, 100])
            .range([0, width]);

        const y = d3.scaleBand()
            .domain(data.map(d => d.region))
            .range([0, barHeight * data.length])
            .padding(0.4);

        // Add X axis
        svg.append("g")
            .attr("transform", `translate(0, ${barHeight * data.length + 10})`)
            .call(d3.axisBottom(x)
                .tickFormat(d => `${d}%`)
                .tickSize(-barHeight * data.length - 10)
                .ticks(6))
            .call(g => g.select(".domain").remove())
            .call(g => g.selectAll(".tick line")
                .attr("stroke", "#EDEDED")
                .attr("stroke-width", 0.75));

        // Add X axis label
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", barHeight * data.length + 40)
            .attr("text-anchor", "middle")
            .style("font-size", "11pt")
            .style("fill", "#7D8CA3")
            .text("Percentage of stocks at biologically sustainable levels (%)");

        // Add Y axis
        svg.append("g")
            .call(d3.axisLeft(y)
                .tickSize(0))
            .call(g => g.select(".domain").remove())
            .selectAll(".tick text")
            .style("font-size", "10pt")
            .style("fill", "#333333");

        // Add horizontal grid lines
        svg.selectAll("horizontalGrid")
            .data(data)
            .enter()
            .append("line")
            .attr("x1", 0)
            .attr("x2", width)
            .attr("y1", d => y(d.region) + y.bandwidth())
            .attr("y2", d => y(d.region) + y.bandwidth())
            .attr("stroke", "#EDEDED")
            .attr("stroke-width", 0.75);

        // Add 50% reference line
        svg.append("line")
            .attr("x1", x(50))
            .attr("x2", x(50))
            .attr("y1", -10)
            .attr("y2", barHeight * data.length + 5)
            .attr("stroke", "#AAAAAA")
            .attr("stroke-width", 1.5)
            .attr("stroke-dasharray", "4,4");

        // Add reference line label
        svg.append("text")
            .attr("class", "threshold-label")
            .attr("x", x(50))
            .attr("y", -15)
            .attr("text-anchor", "middle")
            .text("50% threshold");

        // Add a subtle background for the 50% threshold area
        svg.append("rect")
            .attr("x", x(50))
            .attr("y", -10)
            .attr("width", width - x(50))
            .attr("height", barHeight * data.length + 15)
            .attr("fill", "#F8F8F8")
            .attr("opacity", 0.3)
            .lower(); // Send to back

        // Add bars
        svg.selectAll(".bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", 0)
            .attr("y", d => y(d.region))
            .attr("width", d => x(d.value))
            .attr("height", y.bandwidth())
            .attr("fill", d => colorScale(d))
            .attr("rx", 3)
            .attr("ry", 3);

        // Add percentage labels for ALL bars
        svg.selectAll(".label")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "percentage")
            .attr("x", d => x(d.value) + 5)
            .attr("y", d => y(d.region) + y.bandwidth() / 2 + 5)
            .attr("fill", d => colorScale(d))
            .text(d => `${d.value}%`);

        // Add annotations with improved positioning and spacing
        // Only add 3 key annotations to avoid clutter and overlap
        
        // Annotation for Eastern Central Pacific (77) - top performer
        svg.append("foreignObject")
            .attr("x", x(84.2) + 10)
            .attr("y", y("Eastern Central Pacific (77)") - 10)
            .attr("width", 220)
            .attr("height", 60)
            .html(`<div class="annotation">Strong regional frameworks via Inter-American Tropical Tuna Commission</div>`);
            
        svg.append("line")
            .attr("x1", x(84.2))
            .attr("y1", y("Eastern Central Pacific (77)") + y.bandwidth() / 2)
            .attr("x2", x(84.2) + 10)
            .attr("y2", y("Eastern Central Pacific (77)") + 10)
            .attr("stroke", "#191970")
            .attr("stroke-width", 1);
            
        // Annotation for Northeast Pacific (67)
        svg.append("foreignObject")
            .attr("x", x(76.5) + 10)
            .attr("y", y("Northeast Pacific (67)") - 10)
            .attr("width", 220)
            .attr("height", 60)
            .html(`<div class="annotation">MSY-aligned TACs set by North Pacific Fishery Management Council</div>`);
            
        svg.append("line")
            .attr("x1", x(76.5))
            .attr("y1", y("Northeast Pacific (67)") + y.bandwidth() / 2)
            .attr("x2", x(76.5) + 10)
            .attr("y2", y("Northeast Pacific (67)") + 10)
            .attr("stroke", "#191970")
            .attr("stroke-width", 1);
            
        // Annotation for Mediterranean & Black Sea (37) - repositioned higher to avoid overlap
        svg.append("foreignObject")
            .attr("x", x(37.5) + 10)
            .attr("y", y("Mediterranean & Black Sea (37)") - 30)
            .attr("width", 220)
            .attr("height", 60)
            .html(`<div class="annotation">0.8% improvement since 2019, still highly overexploited</div>`);
            
        svg.append("line")
            .attr("x1", x(37.5))
            .attr("y1", y("Mediterranean & Black Sea (37)") + y.bandwidth() / 2)
            .attr("x2", x(37.5) + 10)
            .attr("y2", y("Mediterranean & Black Sea (37)") - 5)
            .attr("stroke", "#191970")
            .attr("stroke-width", 1);
            
        // Annotation for Southeast Pacific (87) - moved to right side with more space
        svg.append("foreignObject")
            .attr("x", x(33.3) + 10)
            .attr("y", y("Southeast Pacific (87)") + 10)
            .attr("width", 220)
            .attr("height", 80)
            .html(`<div class="annotation">Severe overexploitation of jumbo flying squid, South American pilchard, and hake stocks</div>`);
            
        svg.append("line")
            .attr("x1", x(33.3))
            .attr("y1", y("Southeast Pacific (87)") + y.bandwidth() / 2)
            .attr("x2", x(33.3) + 10)
            .attr("y2", y("Southeast Pacific (87)") + 30)
            .attr("stroke", "#191970")
            .attr("stroke-width", 1);
    </script>
</body>
</html>