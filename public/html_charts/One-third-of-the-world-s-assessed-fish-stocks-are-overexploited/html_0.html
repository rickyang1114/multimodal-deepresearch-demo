<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Decline in Biologically Sustainable Fish Stocks</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        padding: 0;
      }

      .chart-container {
        width: 850px;
        height: 550px;
        position: relative;
      }

      .title {
        font-size: 18pt;
        font-weight: bold;
        color: #2a3045;
        margin-bottom: 5px;
      }

      .subtitle {
        font-size: 12pt;
        color: #7d8ca3;
        margin-top: 0;
        margin-bottom: 20px;
      }

      .axis-label {
        font-size: 10pt;
        fill: #333;
      }

      .tick text {
        font-size: 10pt;
        fill: #333;
      }

      .grid line {
        stroke: #ededed;
        stroke-width: 0.75px;
      }

      .annotation {
        font-size: 9pt;
        background-color: rgba(125, 140, 163, 0.9);
        border: 1px solid #2a3045;
        border-radius: 3px;
        padding: 4px 8px;
        color: white;
        pointer-events: none;
      }

      .annotation .value {
        font-family: 'Georgia', serif;
        font-size: 11pt;
        font-weight: bold;
        color: #ffffff;
      }

      .legend-item {
        font-size: 10pt;
        font-weight: 500;
      }

      .legend-line {
        display: inline-block;
        width: 20px;
        height: 2px;
        vertical-align: middle;
        margin-right: 5px;
      }

      .legend-point {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        vertical-align: middle;
        margin-left: -3px;
      }
    </style>
  </head>
  <body>
    <div class="chart-container">
      <h1 class="title">Decline in Biologically Sustainable Fish Stocks, 1974-2021</h1>
      <p class="subtitle">Source: FAO State of World Fisheries and Aquaculture (SOFIA) Reports</p>
      <div id="chart"></div>
    </div>

    <script>
      // Data
      const data = [
        { year: 1974, sustainable: 90, unsustainable: 10 },
        { year: 1980, sustainable: 87, unsustainable: 13 },
        { year: 1985, sustainable: 83, unsustainable: 17 },
        { year: 1990, sustainable: 80, unsustainable: 20 },
        { year: 1995, sustainable: 77, unsustainable: 23 },
        { year: 2000, sustainable: 73, unsustainable: 27 },
        { year: 2005, sustainable: 70, unsustainable: 30 },
        { year: 2010, sustainable: 68, unsustainable: 32 },
        { year: 2015, sustainable: 66.9, unsustainable: 33.1 },
        { year: 2019, sustainable: 64.6, unsustainable: 35.4 },
        { year: 2021, sustainable: 62.3, unsustainable: 37.7 },
      ]

      // Annotations - reduced and repositioned
      const annotations = [
        {
          x: 1974,
          y: 90,
          text: "<span class='value'>90%</span> sustainable in 1974",
          dx: 20,
          dy: -25,
          anchor: 'start',
        },
        {
          x: 2021,
          y: 62.3,
          text: "<span class='value'>62.3%</span> sustainable in 2021",
          dx: -20,
          dy: -25,
          anchor: 'end',
        },
        {
          x: 1995,
          y: 77,
          text: "Consistent decline of <span class='value'>~0.5-1%</span> per year",
          dx: 0,
          dy: 40,
          anchor: 'middle',
        },
      ]

      // Set up dimensions - increased for better visibility
      const margin = { top: 40, right: 100, bottom: 60, left: 70 }
      const width = 850 - margin.left - margin.right
      const height = 450 - margin.top - margin.bottom

      // Create SVG
      const svg = d3
        .select('#chart')
        .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left}, ${margin.top})`)

      // Create scales
      const xScale = d3.scaleLinear().domain([1974, 2021]).range([0, width])

      const yScale = d3.scaleLinear().domain([0, 100]).range([height, 0])

      // Create axes
      const xAxis = d3
        .axisBottom(xScale)
        .tickFormat((d) => d)
        .tickValues([1975, 1980, 1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020])

      const yAxis = d3
        .axisLeft(yScale)
        .tickFormat((d) => d + '%')
        .tickSize(-3)
        .ticks(10)

      // Add gridlines
      svg
        .append('g')
        .attr('class', 'grid')
        .call(d3.axisLeft(yScale).tickSize(-width).tickFormat('').ticks(10))

      // Add x-axis
      svg
        .append('g')
        .attr('class', 'x-axis')
        .attr('transform', `translate(0, ${height})`)
        .call(xAxis)
        .selectAll('.tick line')
        .attr('stroke', '#000')
        .attr('stroke-width', 0.5)

      // Add y-axis
      svg
        .append('g')
        .attr('class', 'y-axis')
        .call(yAxis)
        .selectAll('.tick line')
        .attr('stroke', '#000')
        .attr('stroke-width', 0.5)

      // Add axis labels
      svg
        .append('text')
        .attr('class', 'axis-label')
        .attr('x', width / 2)
        .attr('y', height + 40)
        .attr('text-anchor', 'middle')
        .text('Year')

      svg
        .append('text')
        .attr('class', 'axis-label')
        .attr('transform', 'rotate(-90)')
        .attr('x', -height / 2)
        .attr('y', -45)
        .attr('text-anchor', 'middle')
        .text('Percentage of assessed stocks (%)')

      // Create line generators
      const sustainableLine = d3
        .line()
        .x((d) => xScale(d.year))
        .y((d) => yScale(d.sustainable))

      const unsustainableLine = d3
        .line()
        .x((d) => xScale(d.year))
        .y((d) => yScale(d.unsustainable))

      // Create area generator
      const area = d3
        .area()
        .x((d) => xScale(d.year))
        .y0(height)
        .y1((d) => yScale(d.sustainable))

      // Add area
      svg
        .append('path')
        .datum(data)
        .attr('fill', '#4ABDAC')
        .attr('fill-opacity', 0.3)
        .attr('d', area)

      // Add sustainable line
      svg
        .append('path')
        .datum(data)
        .attr('fill', 'none')
        .attr('stroke', '#4ABDAC')
        .attr('stroke-width', 1.5)
        .attr('d', sustainableLine)

      // Add unsustainable line
      svg
        .append('path')
        .datum(data)
        .attr('fill', 'none')
        .attr('stroke', '#FC4A1A')
        .attr('stroke-width', 1.5)
        .attr('d', unsustainableLine)

      // Add data points for sustainable line
      svg
        .selectAll('.sustainable-point')
        .data(data)
        .enter()
        .append('circle')
        .attr('class', 'sustainable-point')
        .attr('cx', (d) => xScale(d.year))
        .attr('cy', (d) => yScale(d.sustainable))
        .attr('r', 4)
        .attr('fill', '#4ABDAC')

      // Add data points for unsustainable line
      svg
        .selectAll('.unsustainable-point')
        .data(data)
        .enter()
        .append('circle')
        .attr('class', 'unsustainable-point')
        .attr('cx', (d) => xScale(d.year))
        .attr('cy', (d) => yScale(d.unsustainable))
        .attr('r', 4)
        .attr('fill', '#FC4A1A')

      // Add annotations with improved visibility
      const annotationGroup = svg.append('g').attr('class', 'annotations')

      annotations.forEach((anno) => {
        const g = annotationGroup
          .append('g')
          .attr('transform', `translate(${xScale(anno.x) + anno.dx}, ${yScale(anno.y) + anno.dy})`)

        // Add annotation box with improved styling
        const textElement = g
          .append('foreignObject')
          .attr('width', 180)
          .attr('height', 50)
          .attr('x', anno.anchor === 'end' ? -180 : anno.anchor === 'middle' ? -90 : 0)
          .attr('y', -25)
          .append('xhtml:div')
          .attr('class', 'annotation')
          .style('text-anchor', anno.anchor)
          .html(anno.text)

        // Add connecting line with improved visibility
        g.append('line')
          .attr('x1', anno.anchor === 'end' ? -10 : anno.anchor === 'middle' ? 0 : 10)
          .attr('y1', 0)
          .attr('x2', 0)
          .attr('y2', -anno.dy)
          .attr('stroke', '#2A3045')
          .attr('stroke-width', 1.5)
          .attr('stroke-dasharray', '3,3')
      })

      // Add legend with improved styling to match the actual visualization
      const legend = svg
        .append('g')
        .attr('class', 'legend')
        .attr('transform', `translate(${width - 220}, 10)`)

      // Sustainable legend item with line and point
      const sustainableLegend = legend.append('g').attr('class', 'legend-item')

      sustainableLegend
        .append('line')
        .attr('class', 'legend-line')
        .attr('x1', 0)
        .attr('y1', 6)
        .attr('x2', 20)
        .attr('y2', 6)
        .attr('stroke', '#4ABDAC')
        .attr('stroke-width', 1.5)

      sustainableLegend
        .append('circle')
        .attr('cx', 10)
        .attr('cy', 6)
        .attr('r', 4)
        .attr('fill', '#4ABDAC')

      sustainableLegend
        .append('text')
        .attr('x', 25)
        .attr('y', 10)
        .text('Biologically sustainable stocks')

      // Unsustainable legend item with line and point
      const unsustainableLegend = legend
        .append('g')
        .attr('class', 'legend-item')
        .attr('transform', 'translate(0, 25)')

      unsustainableLegend
        .append('line')
        .attr('class', 'legend-line')
        .attr('x1', 0)
        .attr('y1', 6)
        .attr('x2', 20)
        .attr('y2', 6)
        .attr('stroke', '#FC4A1A')
        .attr('stroke-width', 1.5)

      unsustainableLegend
        .append('circle')
        .attr('cx', 10)
        .attr('cy', 6)
        .attr('r', 4)
        .attr('fill', '#FC4A1A')

      unsustainableLegend.append('text').attr('x', 25).attr('y', 10).text('Overexploited stocks')
    </script>
  </body>
</html>
